# sandbox-configurator
## Оглавление

- [О проекте](#о-проекте)
- [Технологии и инструменты](#технологии-и-инструменты)
- [Требования и подготовка](#требования-и-подготовка)
- [Архитектура решения](#архитектура-решения)
      - [Управление базами данных](#управление-базами-данных)
- [Управление проектами PostgreSQL через Ansible](#управление-проектами-postgresql-через-ansible)
      - [Структура проекта](#структура-проекта)
      - [Описание логики работы](#описание-логики-работы)
      - [Основные команды](#основные-команды)
      - [Пример рабочего процесса](#пример-рабочего-процесса)
- [Полезные комнды ansible](#полезные-комнды-ansible)

## О проекте
Данный проект предназначен для автоматизации создания и управления изолированными учебными окружениями для студентов и преподавателей. Использование подхода "Инфраструктура как код" (IaC) и инструментов DevOps позволяет быстро и безопасно развертывать ресурсы для учебных проектов, обеспечивать повторяемость и автоматизацию процессов.

## Технологии и инструменты
- **Ansible** — автоматизация настройки и управления сервером баз данных.
- **PostgreSQL** — основная СУБД для учебных проектов.
- **Ansible Vault** — безопасное хранение учетных данных и паролей.
- **Linux** — серверная ОС.

## Требования и подготовка
- Linux-сервер с установленным Ansible и PostgreSQL.
- Доступ к серверу по SSH.
- Файл с паролем для Ansible Vault (.vault_pass).
- Заполненные инвентарные файлы и переменные для проектов.

## Архитектура решения

### Управление базами данных
В проекте реализована автоматизированная настройка и управление сервером баз данных для учебных проектов с использованием СУБД PostgreSQL:
- Каждый учебный проект получает отдельного пользователя и базу данных в PostgreSQL.
- Все параметры проектов и учетные данные хранятся в зашифрованных файлах.
- Автоматизация позволяет быстро создавать и удалять окружения для новых учебных задач.

## Управление проектами PostgreSQL через Ansible
### Структура проекта

```
inventories/
└── pg_projects/          # Конфиги проектов (user, db, password)
    └── {project_name}.yml
roles/
└── pg_project/           # Роль для управления проектами
    └── tasks/
        └── main.yml
playbooks/
├── create_project.yml    # Создание нового проекта
└── drop_project.yml      # Удаление проекта
```

### Описание логики работы
Создание и удаление проектов:
- При создании проекта:
      1. Создается отдельный пользователь и база данных.
      2. Пользователь назначается владельцем БД.
      3. Все учетные данные сохраняются в зашифрованном виде.
- При удалении проекта:
      1. Завершаются все подключения к БД.
      2. Удаляется база данных и пользователь.
      3. Файл конфигурации проекта архивируется.

#### Безопасность
1. Все пароли хранятся в зашифрованном виде
2. Используется отдельный пользователь для каждого проекта
3. При удалении проекта все данные безвозвратно удаляются
4. Конфиги удаленных проектов архивируются

### Основные команды
#### Создание нового проекта

```bash
ansible-playbook playbooks/create_project.yml  -e "project_name=timetracker_app"
```

#### Удаление проекта

```bash
ansible-playbook playbooks/drop_project.yml -e "project_name=timetracker_app"
```

### Создание конфигурационного файла для нового проекта

1. Сгенерируйте зашифрованные переменные:
```bash
ansible-vault encrypt_string 'db_user' --name 'user'
ansible-vault encrypt_string 'db_name' --name 'db'
ansible-vault encrypt_string 'secure_password' --name 'password'
```

2. Создайте файл проекта:
```yaml
# inventories/pg_projects/new_project.yml
---
user: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      ...
db: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      ...
password: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      ...
```

### Пример рабочего процесса

1. Создать новый проект:
```bash
ansible-playbook playbooks/create_project.yml -e "project_name=analytics"
```

2. Использовать в приложении:
```python
# Пример подключения
DB_URL = "postgresql://analytics_user:secure_password@localhost/analytics_db"
```

3. Удалить проект после завершения работ:
```bash
ansible-playbook playbooks/drop_project.yml -e "project_name=analytics"
```

## Полезные комнды ansible

### Проверка связи с сервером

Для проверки соединения с сервером используйте команду:

```sh
ansible all -m ping -i inventories/hosts --vault-password-file .vault_pass
```

### Запуск playbook

Для запуска playbook выполните:

```sh
ansible-playbook -i inventories/hosts playbook.yml --vault-password-file .vault_pass
```
### Расшифровка файла, зашифрованного Ansible Vault

Чтобы расшифровать файл, зашифрованный с помощью Ansible Vault, используйте команду:

```sh
ansible-vault decrypt путь/к/файлу --vault-password-file .vault_pass
```

После выполнения этой команды файл будет расшифрован и доступен в открытом виде. Убедитесь, что файл `.vault_pass` содержит правильный пароль и хранится в безопасном месте.

Для вывода значения переменной с помощью Ansible на локальной машине используйте следующую команду:

```sh
ansible localhost -m debug -a "var=имя_переменной" -e "@путь/к/файлу.yml"
```